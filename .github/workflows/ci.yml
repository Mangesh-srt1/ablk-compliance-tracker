name: CI - Compliance System Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'compliance-system/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'compliance-system/**'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        service: [api, agents]
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'compliance-system/package-lock.json'

      - name: Install dependencies (root)
        working-directory: compliance-system
        run: npm ci

      - name: Install dependencies (${{ matrix.service }})
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm ci

      - name: Lint code
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm run lint --if-present

      - name: Type check
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm run typecheck --if-present || npx tsc --noEmit

      - name: Run tests
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm run test:ci --if-present || npm test -- --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/compliance_test_db

      - name: Upload coverage reports
        if: matrix.service == 'api'
        uses: codecov/codecov-action@v3
        with:
          files: ./compliance-system/src/${{ matrix.service }}/coverage/coverage-final.json
          flags: ${{ matrix.service }}
          name: coverage-${{ matrix.service }}
          fail_ci_if_error: false

  coverage-check:
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: 'compliance-system/package-lock.json'

      - name: Install dependencies
        working-directory: compliance-system
        run: npm ci

      - name: Install API dependencies
        working-directory: compliance-system/src/api
        run: npm ci

      - name: Generate coverage report (API)
        working-directory: compliance-system/src/api
        run: npm run test:coverage --if-present || npm test -- --coverage
        continue-on-error: true
        env:
          NODE_ENV: test

      - name: Check coverage threshold
        working-directory: compliance-system/src/api
        run: |
          # Parse coverage summary
          LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
          
          echo "Coverage Results:"
          echo "Lines: $LINES%"
          echo "Functions: $FUNCTIONS%"
          echo "Branches: $BRANCHES%"
          echo "Statements: $STATEMENTS%"
          
          # Check minimum threshold (75%)
          THRESHOLD=75
          if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
            echo "âŒ Lines coverage ($LINES%) below threshold ($THRESHOLD%)"
            exit 1
          fi
          echo "âœ… Coverage check passed"

  sonarqube:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test]
    if: false  # Disabled - use local SonarQube server for analysis

    steps:
      - name: Skipped - Run locally instead
        run: echo "SonarQube analysis runs locally. See SONARQUBE_SETUP.md for instructions"

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        working-directory: compliance-system
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'compliance-system'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build:
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 30

    strategy:
      matrix:
        service: [api, agents]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm ci

      - name: Build TypeScript
        working-directory: compliance-system/src/${{ matrix.service }}
        run: npm run build

      - name: Check bundle size
        working-directory: compliance-system/src/${{ matrix.service }}
        run: |
          SIZE=$(du -sh dist/ | awk '{print $1}')
          echo "Build size: $SIZE"
          # Warn if over 10MB
          SIZE_BYTES=$(du -sb dist/ | awk '{print $1}')
          if [ $SIZE_BYTES -gt 10485760 ]; then
            echo "âš ï¸ Warning: Build size exceeds 10MB"
          fi

  docker-build:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    strategy:
      matrix:
        service: [api, agents]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (if configured)
        uses: docker/login-action@v3
        if: secrets.DOCKER_USERNAME != ''
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: compliance-system
          file: compliance-system/src/${{ matrix.service }}/Dockerfile
          push: ${{ secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/lumina-${{ matrix.service }}:latest
            ${{ secrets.DOCKER_USERNAME }}/lumina-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  status-check:
    runs-on: ubuntu-latest
    needs: [test, security-scan, build]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "Test Status: ${{ needs.test.result }}"
          echo "Security Scan Status: ${{ needs.security-scan.result }}"
          echo "Build Status: ${{ needs.build.result }}"
          
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Tests failed"
            exit 1
          fi
          
          if [ "${{ needs.security-scan.result }}" = "failure" ]; then
            echo "âš ï¸ Security vulnerabilities detected"
          fi
          
          echo "âœ… All critical checks passed"
          echo "ðŸ’¡ Tip: Run SonarQube analysis locally with: npm run sonar"

  notify:
    runs-on: ubuntu-latest
    needs: [status-check]
    if: always()
    
    steps:
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ CI pipeline failed. Please check the workflow logs.'
            })
      
      - name: Notify on success
        if: success()
        run: echo "âœ… CI pipeline passed all checks"
