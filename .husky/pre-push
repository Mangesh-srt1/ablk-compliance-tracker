#!/bin/sh
. "$(cd -- "$(dirname -- "$0")" && pwd)/_/husky.sh"

echo "ğŸ§ª Pre-push hook: Running tests before push..."

# Change to compliance-system directory
cd compliance-system 2>/dev/null || cd "$(dirname -- "$0")/../../compliance-system" || {
  echo "âŒ Could not find compliance-system directory"
  exit 1
}

# Detect if we're pushing to main branch (stricter checks)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“¤ Pushing to branch: $BRANCH"

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "ğŸ”´ Pushing to main branch - Running full test suite..."
  npm run test:ci || {
    echo "âŒ Tests failed - Push blocked"
    echo "ğŸ’¡ Tip: Run 'npm run test:coverage' locally to debug"
    exit 1
  }
else
  echo "ğŸŸ¡ Pushing to feature branch - Running quick tests..."
  npm run test:unit || {
    echo "âš ï¸ Unit tests failed"
    echo "ğŸ’¡ Tip: Fix tests locally before pushing"
    exit 1
  }
fi

echo ""
echo "âœ… Pre-push hook passed! Proceeding with push."
exit 0
