#!/bin/sh
. "$(cd -- "$(dirname -- "$0")" && pwd)/_/husky.sh"

echo "ğŸ” Pre-commit hook: Running linting and type checking..."

# Change to compliance-system directory if not already there
cd compliance-system 2>/dev/null || cd "$(dirname -- "$0")/../../compliance-system" || {
  echo "âŒ Could not find compliance-system directory"
  exit 1
}

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No TypeScript/JavaScript files to check"
  exit 0
fi

echo "ğŸ“ Staged files:"
echo "$STAGED_FILES" | sed 's/^/   /'

# Run ESLint on staged files
echo ""
echo "ğŸ”§ Running ESLint..."
npx eslint $STAGED_FILES --max-warnings 0 || {
  echo "âŒ ESLint check failed"
  exit 1
}

echo "âœ… ESLint passed"

# Run TypeScript compiler (type check only)
echo ""
echo "ğŸ”· Running TypeScript type check..."
npx tsc --noEmit || {
  echo "âŒ TypeScript type check failed"
  exit 1
}

echo "âœ… TypeScript type check passed"

echo ""
echo "âœ… Pre-commit hook passed! Ready to commit."
exit 0
