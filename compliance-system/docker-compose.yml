version: '3.8'

services:
  # ===== HYPERLEDGER BESU =====

  besu-validator-1:
    image: hyperledger/besu:latest
    container_name: compliance-besu-validator-1
    command:
      - --config-file=/data/besu-config.toml
      - --data-path=/data
      - --genesis-file=/data/genesis.json
      - --host-allowlist=*
      - --node-private-key-file=/data/key
      - --p2p-port=30303
      - --rpc-http-enabled=true
      - --rpc-http-host=0.0.0.0
      - --rpc-http-port=8545
      - --rpc-http-api=ETH,NET,QBFT,ADMIN,PERM
      - --rpc-http-cors-origins=*
      - --permissions-accounts-config-file-enabled=true
      - --permissions-accounts-config-file=/data/permissions_config.toml
    ports:
      - '8545:8545'
      - '8546:8546'
      - '30303:30303'
    volumes:
      - besu-validator-1-data:/data
      - ./backend/besu-config/besu-config.toml:/data/besu-config.toml
      - ./backend/besu-config/genesis.json:/data/genesis.json
      - ./backend/besu-config/permissions_config.toml:/data/permissions_config.toml
      - ./backend/besu-config/besu-genesis/keys/0x05017782c3ae1553fc85d8f4028aed6a1cf8348c/key.priv:/data/key
      - ./backend/besu-config/static-nodes.json:/data/static-nodes.json
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ['CMD', 'test', '-f', '/data/genesis.json']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: compliance-postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - '${DB_PORT}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER} -d ${DB_NAME}']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: compliance-redis
    ports:
      - '${REDIS_PORT}:6379'
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Grafana Monitoring
  grafana:
    image: grafana/grafana:latest
    container_name: compliance-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    ports:
      - '${GRAFANA_PORT:-3001}:3000'
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/grafana-dashboards:/etc/grafana/provisioning/dashboards
      - ./infrastructure/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test:
        ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # Compliance API Gateway
  compliance-gateway:
    build:
      context: ./src/api
      dockerfile: Dockerfile
    container_name: compliance-gateway
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      JWT_SECRET: ${JWT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - '3000:3000'
    volumes:
      - ./src/api/src:/app/src
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost:3000/health || exit 1']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # AI Compliance Agents (LangGraph)
  compliance-agents:
    build:
      context: ./src/agents
      dockerfile: Dockerfile
    container_name: compliance-agents
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3002
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      REDIS_URL: redis://redis:6379
      GROK_API_KEY: ${GROK_API_KEY}
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - '3002:3002'
    volumes:
      - ./src/agents/src:/app/src
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost:3002/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Compliance Dashboard (React)
  compliance-dashboard:
    build:
      context: ./src/dashboard
      dockerfile: Dockerfile
    container_name: compliance-dashboard
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3001
      REACT_APP_API_URL: http://compliance-gateway:3000
      REACT_APP_WS_URL: ws://compliance-gateway:3000
    ports:
      - '3001:80'
    volumes:
      - ./src/dashboard/src:/app/src
      - ./src/dashboard/public:/app/public
    networks:
      - compliance-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    depends_on:
      - compliance-gateway

volumes:
  besu-validator-1-data:
  postgres_data:
  grafana_data:

networks:
  compliance-network:
    driver: bridge
